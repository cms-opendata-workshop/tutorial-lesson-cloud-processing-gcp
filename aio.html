<!DOCTYPE html>
<!-- START: inst/pkgdown/templates/layout.html --><!-- Generated by pkgdown: do not edit by hand --><html lang="en" data-bs-theme="auto">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<title>CMS Open Data processing in Google Cloud Platform (GCP): All in One View</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="assets/themetoggle.js"></script><link rel="stylesheet" type="text/css" href="assets/styles.css">
<script src="assets/scripts.js" type="text/javascript"></script><!-- mathjax --><script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      config: ["MMLorHTML.js"],
      jax: ["input/TeX","input/MathML","output/HTML-CSS","output/NativeMML", "output/PreviewHTML"],
      extensions: ["tex2jax.js","mml2jax.js","MathMenu.js","MathZoom.js", "fast-preview.js", "AssistiveMML.js", "a11y/accessibility-menu.js"],
      TeX: {
        extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"]
      },
      tex2jax: {
        inlineMath: [['\\(', '\\)']],
        displayMath: [ ['$$','$$'], ['\\[', '\\]'] ],
        processEscapes: true
      }
    });
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><!-- Responsive Favicon for The Carpentries --><link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
<link rel="manifest" href="site.webmanifest">
<link rel="mask-icon" href="safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="white">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="black">
</head>
<body>
    <header id="top" class="navbar navbar-expand-md top-nav incubator"><svg xmlns="http://www.w3.org/2000/svg" class="d-none"><symbol id="check2" viewbox="0 0 16 16"><path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"></path></symbol><symbol id="circle-half" viewbox="0 0 16 16"><path d="M8 15A7 7 0 1 0 8 1v14zm0 1A8 8 0 1 1 8 0a8 8 0 0 1 0 16z"></path></symbol><symbol id="moon-stars-fill" viewbox="0 0 16 16"><path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"></path><path d="M10.794 3.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387a1.734 1.734 0 0 0-1.097 1.097l-.387 1.162a.217.217 0 0 1-.412 0l-.387-1.162A1.734 1.734 0 0 0 9.31 6.593l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387a1.734 1.734 0 0 0 1.097-1.097l.387-1.162zM13.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.156 1.156 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.156 1.156 0 0 0-.732-.732l-.774-.258a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"></path></symbol><symbol id="sun-fill" viewbox="0 0 16 16"><path d="M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"></path></symbol></svg><a class="visually-hidden-focusable skip-link" href="#main-content">Skip to main content</a>
  <div class="container-fluid top-nav-container">
    <div class="col-md-8">
      <div class="large-logo">
        <img id="dpoa-logo" alt="CMS DPOA logo" src="assets/images/dpoa-logo.png"><span class="badge text-bg-danger">
          <abbr title="This lesson is in the pre-alpha phase, which means that it is in early development, but has not yet been taught.">
            <a href="https://cdh.carpentries.org/the-lesson-life-cycle.html#early-development-pre-alpha-through-alpha" class="external-link alert-link">
              <i aria-hidden="true" class="icon" data-feather="alert-octagon" style="border-radius: 5px"></i>
              Pre-Alpha
            </a>
            <span class="visually-hidden">This lesson is in the pre-alpha phase, which means that it is in early development, but has not yet been taught.</span>
          </abbr>
        </span>

      </div>
    </div>
    <div class="selector-container">
      <div id="theme-selector">
        <li class="nav-item dropdown" id="theme-button-list">
          <button class="btn btn-link nav-link px-0 px-lg-2 dropdown-toggle d-flex align-items-center" id="bd-theme" type="button" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme (auto)">
            <svg class="bi my-1 theme-icon-active"><use href="#circle-half"></use></svg><i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="bd-theme-text">
<li>
              <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
                <svg class="bi me-2 theme-icon"><use href="#sun-fill"></use></svg>
                Light
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
            <li>
              <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
                <svg class="bi me-2 theme-icon"><use href="#moon-stars-fill"></use></svg>
                Dark
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
            <li>
              <button type="button" class="btn dropdown-item d-flex align-items-center active" data-bs-theme-value="auto" aria-pressed="true">
                <svg class="bi me-2 theme-icon"><use href="#circle-half"></use></svg>
                Auto
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
          </ul>
</li>
      </div>

      <div class="dropdown" id="instructor-dropdown">
        <button class="btn btn-secondary dropdown-toggle bordered-button" type="button" id="dropdownMenu1" data-bs-toggle="dropdown" aria-expanded="false">
          <i aria-hidden="true" class="icon" data-feather="eye"></i> Learner View <i data-feather="chevron-down"></i>
        </button>
        <ul class="dropdown-menu" aria-labelledby="dropdownMenu1">
<li><button class="dropdown-item" type="button" onclick="window.location.href='instructor/aio.html';">Instructor View</button></li>
        </ul>
</div>
    </div>
  </div>
  <hr></header><nav class="navbar navbar-expand-xl bottom-nav incubator" aria-label="Main Navigation"><div class="container-fluid nav-container">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle Navigation">
      <span class="navbar-toggler-icon"></span>
      <span class="menu-title">Menu</span>
    </button>
    <div class="nav-logo">
      <img class="small-logo" alt="CMS DPOA small logo" src="assets/images/dpoa-logo-sm.png">
</div>
    <div class="lesson-title-md">
      CMS Open Data processing in Google Cloud Platform (GCP)
    </div>
    <div class="search-icon-sm">
      <!-- TODO: do not show until we have search
        <i role="img" aria-label="Search the All In One page" data-feather="search"></i>
      -->
    </div>
    <div class="desktop-nav">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
<li class="nav-item">
          <span class="lesson-title">
            CMS Open Data processing in Google Cloud Platform (GCP)
          </span>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="key-points.html">Key Points</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="reference.html#glossary">Glossary</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="profiles.html">Learner Profiles</a>
        </li>
        <li class="nav-item dropdown">
          <button class="nav-link dropdown-toggle" id="navbarDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            More <i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
<li><a class="dropdown-item" href="reference.html">Reference</a></li>
          </ul>
</li>
      </ul>
</div>
    <!--
    <form class="d-flex col-md-2 search-form">
      <fieldset disabled>
      <input class="form-control me-2 searchbox" type="search" placeholder="" aria-label="">
        <button class="btn btn-outline-success tablet-search-button"  type="submit">
          <i class="search-icon" data-feather="search" role="img" aria-label="Search the All In One page"></i>
        </button>
      </fieldset>
    </form>
    -->
    <a id="search-button" class="btn btn-primary" href="aio.html" role="button" aria-label="Search the All In One page">Search the All In One page</a>
  </div>
<!--/div.container-fluid -->
</nav><div class="col-md-12 mobile-title">
  CMS Open Data processing in Google Cloud Platform (GCP)
</div>

<aside class="col-md-12 lesson-progress"><div style="width: %" class="percentage">
    %
  </div>
  <div class="progress incubator">
    <div class="progress-bar incubator" role="progressbar" style="width: %" aria-valuenow="" aria-label="Lesson Progress" aria-valuemin="0" aria-valuemax="100">
    </div>
  </div>
</aside><div class="container">
      <div class="row">
        <!-- START: inst/pkgdown/templates/navbar.html -->
<div id="sidebar-col" class="col-lg-4">
  <div id="sidebar" class="sidebar">
      <nav aria-labelledby="flush-headingEleven"><button role="button" aria-label="close menu" alt="close menu" aria-expanded="true" aria-controls="sidebar" class="collapse-toggle" data-collapse="Collapse " data-episodes="Episodes ">
          <i class="search-icon" data-feather="x" role="img"></i>
        </button>
        <div class="sidebar-inner">
          <div class="row mobile-row" id="theme-row-mobile">
            <div class="col" id="theme-selector">
              <li class="nav-item dropdown" id="theme-button-list">
                <button class="btn btn-link nav-link px-0 px-lg-2 dropdown-toggle d-flex align-items-center" id="bd-theme" type="button" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme (auto)">
                  <svg class="bi my-1 theme-icon-active"><use href="#circle-half"></use></svg><span class="d-lg-none ms-1" id="bd-theme-text">Toggle Theme</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-right" aria-labelledby="bd-theme-text">
<li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
                      <svg class="bi me-2 theme-icon"><use href="#sun-fill"></use></svg>
                      Light
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                  <li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
                      <svg class="bi me-2 theme-icon"><use href="#moon-stars-fill"></use></svg>
                      Dark
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                  <li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center active" data-bs-theme-value="auto" aria-pressed="true">
                      <svg class="bi me-2 theme-icon"><use href="#circle-half"></use></svg>
                      Auto
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                </ul>
</li>
            </div>
          </div>
          <div class="row mobile-row">
            <div class="col">
              <div class="sidenav-view-selector">
                <div class="accordion accordion-flush" id="accordionFlush9">
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="flush-headingNine">
                      <button class="accordion-button collapsed" id="instructor" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseNine" aria-expanded="false" aria-controls="flush-collapseNine">
                        <i id="eye" aria-hidden="true" class="icon" data-feather="eye"></i> Learner View
                      </button>
                    </h2>
                    <div id="flush-collapseNine" class="accordion-collapse collapse" aria-labelledby="flush-headingNine" data-bs-parent="#accordionFlush2">
                      <div class="accordion-body">
                        <a href="instructor/aio.html">Instructor View</a>
                      </div>
                    </div>
                  </div>
<!--/div.accordion-item-->
                </div>
<!--/div.accordion-flush-->
              </div>
<!--div.sidenav-view-selector -->
            </div>
<!--/div.col -->

            <hr>
</div>
<!--/div.mobile-row -->

          <div class="accordion accordion-flush" id="accordionFlush11">
            <div class="accordion-item">

              <button id="chapters" class="accordion-button show" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseEleven" aria-expanded="false" aria-controls="flush-collapseEleven">
                <h2 class="accordion-header chapters" id="flush-headingEleven">
                  EPISODES
                </h2>
              </button>
              <div id="flush-collapseEleven" class="accordion-collapse show collapse" aria-labelledby="flush-headingEleven" data-bs-parent="#accordionFlush11">

                <div class="accordion-body">
                  <div class="accordion accordion-flush" id="accordionFlush1">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading1">
        <a href="index.html">Summary and Setup</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush2">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading2">
        <a href="01-intro.html">1. Introduction</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush3">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading3">
        <a href="02-storage.html">2. Persistent storage</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush4">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading4">
        <a href="03-disk-image-manual.html">3. Disk image</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush5">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading5">
        <a href="04-cluster.html">4. Kubernetes cluster</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

                </div>
              </div>
            </div>

            <hr class="half-width">
<div class="accordion accordion-flush resources" id="accordionFlush12">
              <div class="accordion-item">
                <h2 class="accordion-header" id="flush-headingTwelve">
                  <button class="accordion-button collapsed" id="resources" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseTwelve" aria-expanded="false" aria-controls="flush-collapseTwelve">
                    RESOURCES
                  </button>
                </h2>
                <div id="flush-collapseTwelve" class="accordion-collapse collapse" aria-labelledby="flush-headingTwelve" data-bs-parent="#accordionFlush12">
                  <div class="accordion-body">
                    <ul>
<li>
                        <a href="key-points.html">Key Points</a>
                      </li>
                      <li>
                        <a href="reference.html#glossary">Glossary</a>
                      </li>
                      <li>
                        <a href="profiles.html">Learner Profiles</a>
                      </li>
                      <li><a href="reference.html">Reference</a></li>
                    </ul>
</div>
                </div>
              </div>
            </div>
            <hr class="half-width resources">
<a href="aio.html">See all in one page</a>


            <hr class="d-none d-sm-block d-md-none">
<div class="d-grid gap-1">

            </div>
          </div>
<!-- /div.accordion -->
        </div>
<!-- /div.sidebar-inner -->
      </nav>
</div>
<!-- /div.sidebar -->
  </div>
<!-- /div.sidebar-col -->
<!-- END:   inst/pkgdown/templates/navbar.html-->

        <!-- START: inst/pkgdown/templates/content-extra.html -->
  <div class="col-xl-8 col-lg-12 primary-content">
    <main id="main-content" class="main-content"><div class="container lesson-content">
        
        
<section id="aio-01-intro"><p>Content from <a href="01-intro.html">Introduction</a></p>
<hr>
<p>Last updated on 2024-10-14 |

        <a href="https://github.com/cms-opendata-workshop/tutorial-lesson-cloud-processing-gcp/edit/main/episodes/01-intro.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>What are public cloud provides?</li>
<li>Why would you use them?</li>
<li>What is Kubernetes?</li>
<li>What else do you need?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Explain the motivation for using Kubernetes cluster from public
cloud providers.</li>
<li>Explain the tools used to set up the Kubernetes cluster and run the
processing workflow.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<section><h2 class="section-heading" id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<hr class="half-width">
<p>This tutorial shows how to set up a CMS open data processing workflow
using Kubernetes clusters from Google Cloud Platform (GCP).</p>
<div id="callout1" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Callout</h3>
<div class="callout-content">
<p>To learn about CMS open data and the different data formats, work
through the tutorials in one of our <a href="https://cms-opendata-guide.web.cern.ch/cmsOpenData/workshops/" class="external-link">workshops</a>.</p>
</div>
</div>
</div>
<p>This is an option for you if you do not have enough computing
resources and want to run some heavy processing. In this tutorial, we
use as an <a href="https://opendata.cern.ch/record/12504" class="external-link">example
processing</a> of CMS open data MiniAOD to a “custom” NanoAOD, including
more information than the standard NanoAOD but still in the same flat
file format.</p>
<p>We assume that you would want to download the output files to your
local area and analyse them with your own resources. Note that analysis
using GCP resources with your files stored on GCP is also possible, but
is not covered in this tutorial.</p>
</section><section><h2 class="section-heading" id="google-cloud-platform">Google Cloud Platform<a class="anchor" aria-label="anchor" href="#google-cloud-platform"></a>
</h2>
<hr class="half-width">
<p>Public cloud providers are companies that offers computing resources
and services over the internet to multiple users or organizations.
Google Cloud Platform (GCP) is one of them. You define the resources
that you need and pay for what you use. As many other such resource
providers (for example AWS, Azure, OHV), it offers some free
getting-started “credits”.</p>
<div id="callout2" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Callout</h3>
<div class="callout-content">
<p>This tutorial was set up using <a href="https://cloud.google.com/edu/researchers" class="external-link">Google Cloud Research
credits</a>. You can apply for similar credits for your research
projects. Take note that the credit has to be used within 12 months.</p>
</div>
</div>
</div>
<p>You can create, manage and delete resources using the Google Cloud
Console (a Web UI) or a command-line tool <code>gcloud</code>.</p>
<p>In this tutorial, we use <code>gcloud</code> commands to create the
persistent storage for the output data, and a Terraform script to
provision the Kubernetes cluster where the processing workflow will
run.</p>
</section><section><h2 class="section-heading" id="terraform">Terraform<a class="anchor" aria-label="anchor" href="#terraform"></a>
</h2>
<hr class="half-width">
<p><a href="https://www.terraform.io/" class="external-link">Terraform</a> is a tool to
define, provision, and manage cloud infrastructure using configuration
scripts.</p>
<p>In this tutorial, we use Terraform scripts to create the Kubernetes
cluster in a single step. The advantage - compared to plain command-line
<code>gcloud</code> commands - is that we can easily configure input
variables. Also, after the workflow finishes, it is easy to delete the
resources in a single step.</p>
</section><section><h2 class="section-heading" id="kubernetes">Kubernetes<a class="anchor" aria-label="anchor" href="#kubernetes"></a>
</h2>
<hr class="half-width">
<p>Kubernetes is a system to managed containerized workflows on
computing clusters. <code>kubectl</code> is the command-line tool to
interact with the cluster resources.</p>
<p>In this tutorial, we use <code>kubectl</code> commands to set up some
services and to observe the status of the cluster and the data
processing workflow.</p>
</section><section><h2 class="section-heading" id="argo-workflows">Argo Workflows<a class="anchor" aria-label="anchor" href="#argo-workflows"></a>
</h2>
<hr class="half-width">
<p>The processing workflow consist of some sequential and parallel
steps. We use <a href="https://argoproj.github.io/workflows/" class="external-link">Argo
Workflows</a> to define (or “orchestrate”) the workflow steps.</p>
<p>In this tutorial, the Argo Workflows services are set up using a
<code>kubectl</code> command. We use <code>argo</code>, the command-line
tool, to submit and manage the workflows.</p>
<div id="ready-to-go" class="callout checklist">
<div class="callout-square">
<i class="callout-icon" data-feather="check-square"></i>
</div>
<div id="ready-to-go" class="callout-inner">
<h3 class="callout-title">Ready to go?</h3>
<div class="callout-content">
<p>Check the instructions in <a href="index.html#software-setup">Software setup</a></p>
<ul class="task-list">
<li><label><input type="checkbox">a GCP account and a GCP
project</label></li>
<li><label><input type="checkbox">Linux shell available (Linux, macOS
or WSL2 on Windows)</label></li>
<li><label><input type="checkbox">gcloud installed</label></li>
<li><label><input type="checkbox">kubectl installed</label></li>
<li><label><input type="checkbox">Terraform installed</label></li>
<li><label><input type="checkbox">go installed</label></li>
<li><label><input type="checkbox">Argo CLI installed</label></li>
</ul>
<p>When done, let’s go!</p>
</div>
</div>
</div>
<div id="accordionSpoiler1" class="accordion spoiler-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button spoiler-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSpoiler1" aria-expanded="false" aria-controls="collapseSpoiler1">
  <h3 class="accordion-header" id="headingSpoiler1">
  <div class="note-square"><i aria-hidden="true" class="callout-icon" data-feather="eye"></i></div>
  Too much to install? I just want a quick try…
  </h3>
</button>
<div id="collapseSpoiler1" class="accordion-collapse collapse" data-bs-parent="#accordionSpoiler1" aria-labelledby="headingSpoiler1">
<div class="accordion-body">
<p>If you don’t have access to a Linux terminal or prefer not to install
tools locally, you can use Google Cloud Shell. You’ll need a Google
Cloud Platform (GCP) account and a GCP project. To open Cloud Shell,
click the Cloud Shell icon in the top-right corner of the Google Cloud
Console.</p>
<p>Cloud Shell comes pre-installed with gcloud, kubectl, terraform, and
go. However, you’ll need to install the Argo CLI manually</p>
</div>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points</h3>
<div class="callout-content">
<ul>
<li>Public cloud providers are companies that offer pay-as-you-go
computing resources and services over the internet to multiple users or
organizations.</li>
<li>Terraform is an open-source tool to provision and delete computing
infrastructure.</li>
<li>Kubernetes is an open-source system for automating deployment,
scaling, and management of containerized applications and their
associated workflows across clusters of hosts..</li>
<li>Argo Workflows is an open-source tool for orchestrating sequential
and parallel jobs on Kubernetes.</li>
</ul>
</div>
</div>
</div>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</section></section><section id="aio-02-storage"><p>Content from <a href="02-storage.html">Persistent storage</a></p>
<hr>
<p>Last updated on 2024-10-16 |

        <a href="https://github.com/cms-opendata-workshop/tutorial-lesson-cloud-processing-gcp/edit/main/episodes/02-storage.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How to create a Google Cloud Storage bucket?</li>
<li>What are the basic operations?</li>
<li>What are the cost of storage and download?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Learn to create a Google Cloud Storage bucket</li>
<li>Learn to list the contents of a bukcet</li>
<li>Understand the persistant storage costs.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<section><h2 class="section-heading" id="storage-for-the-output-files">Storage for the output files<a class="anchor" aria-label="anchor" href="#storage-for-the-output-files"></a>
</h2>
<hr class="half-width">
<p>The processing workflow writes the output files to a storage from
which they can be downloaded afterwards.</p>
<p>For this tutorial, we use a <a href="https://cloud.google.com/storage/docs/buckets" class="external-link">Google Cloud
Storage (GCS) bucket</a>.</p>
<div id="callout1" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Callout</h3>
<div class="callout-content">
<p>The storage is created separately from the cluster resources. You can
then delete the cluster just after the processing and avoid unnecessary
costs, but keep the output files.</p>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="prerequisites">Prerequisites<a class="anchor" aria-label="anchor" href="#prerequisites"></a>
</h2>
<hr class="half-width">
<div class="section level3">
<h3 id="gcp-account-and-project">GCP account and project<a class="anchor" aria-label="anchor" href="#gcp-account-and-project"></a>
</h3>
<p>Make sure that you are in the GCP account and project that you intend
to use for this work. In your Linux terminal, type</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="ex">gcloud</span> config list</span></code></pre>
</div>
<p>The output shows your account and project.</p>
<div id="accordionSpoiler1" class="accordion spoiler-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button spoiler-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSpoiler1" aria-expanded="false" aria-controls="collapseSpoiler1">
  <h3 class="accordion-header" id="headingSpoiler1">
  <div class="note-square"><i aria-hidden="true" class="callout-icon" data-feather="eye"></i></div>
  How to change them?
  </h3>
</button>
<div id="collapseSpoiler1" class="accordion-collapse collapse" data-bs-parent="#accordionSpoiler1" aria-labelledby="headingSpoiler1">
<div class="accordion-body">
<p>If they are not what you expect (in case you have many), change them
with</p>
<pre class="bask"><code>gcloud config set account &lt;ACCOUNT&gt;</code></pre>
<p>and</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="ex">gcloud</span> config set project <span class="op">&lt;</span>PROJECT_ID<span class="op">&gt;</span></span></code></pre>
</div>
<div class="section level4">
<h4 id="accounts">Accounts<a class="anchor" aria-label="anchor" href="#accounts"></a>
</h4>
<p>You can can check the credentialed accounts with</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="ex">gcloud</span> auth list</span></code></pre>
</div>
<p>If you get none or your account does not appear in the list, run</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="ex">gcloud</span> init</span></code></pre>
</div>
<p>and follow the steps in the output.</p>
</div>
<div class="section level4">
<h4 id="projects">Projects<a class="anchor" aria-label="anchor" href="#projects"></a>
</h4>
<p>List the projects within the active account with</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="ex">gcloud</span> projects list</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="section level3">
<h3 id="billing-account">Billing account?<a class="anchor" aria-label="anchor" href="#billing-account"></a>
</h3>
<p>If this is your first project or you created it from the Google Cloud
Console Web UI, it will have a billing account linked to it.</p>
<p>If you created the project from the command line without specifying
the billing account, you must link it to an existing billing
account.</p>
<div id="accordionSpoiler2" class="accordion spoiler-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button spoiler-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSpoiler2" aria-expanded="false" aria-controls="collapseSpoiler2">
  <h3 class="accordion-header" id="headingSpoiler2">
  <div class="note-square"><i aria-hidden="true" class="callout-icon" data-feather="eye"></i></div>
  How to link a project to your billing account?
  </h3>
</button>
<div id="collapseSpoiler2" class="accordion-collapse collapse" data-bs-parent="#accordionSpoiler2" aria-labelledby="headingSpoiler2">
<div class="accordion-body">
<p>First list the billing accounts</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="ex">gcloud</span> billing accounts list</span></code></pre>
</div>
<p>Take the account id from the output, and check if your project is
linked to it</p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="ex">gcloud</span> billing projects list <span class="at">--billing-account</span> <span class="op">&lt;</span>ACCOUNT_ID<span class="op">&gt;</span></span></code></pre>
</div>
<p>If not, link your project to this account with</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="ex">gcloud</span> billing projects link <span class="op">&lt;</span>PROJECT_ID<span class="op">&gt;</span> --billing-account <span class="op">&lt;</span>ACCOUNT_ID<span class="op">&gt;</span></span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="section level3">
<h3 id="choose-your-region">Choose your region<a class="anchor" aria-label="anchor" href="#choose-your-region"></a>
</h3>
<p>In this tutorial, we will use the Google computing centre
<code>europe-west4</code> located in Netherlands. You can use another
one, but use it consistently.</p>
<p>If you computing resources are in a different region than your
storage, additional cost and delay may occur.</p>
</div>
</section><section><h2 class="section-heading" id="create-the-bucket">Create the bucket<a class="anchor" aria-label="anchor" href="#create-the-bucket"></a>
</h2>
<hr class="half-width">
<p>Create a storage bucket with</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="ex">gcloud</span> storage buckets create gs://<span class="op">&lt;</span>BUCKET_NAME<span class="op">&gt;</span> --location europe-west4</span></code></pre>
</div>
<p>You can test copying a file to it with</p>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="bu">echo</span> test <span class="op">&gt;</span> test.txt</span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a><span class="ex">gcloud</span> storage cp test.txt gs://<span class="op">&lt;</span>BUCKET_NAME<span class="op">&gt;</span>/</span></code></pre>
</div>
<p>and list the contents of the bucket with</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="ex">gcloud</span> storage ls gs://<span class="op">&lt;</span>BUCKET_NAME<span class="op">&gt;</span>/<span class="pp">*</span></span></code></pre>
</div>
<p>You can remove the file with</p>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="ex">gcloud</span> storage rm gs://<span class="op">&lt;</span>BUCKET_NAME<span class="op">&gt;</span>/test.txt</span></code></pre>
</div>
<p>Note that the bucket is tied to your GCP project and you can only
access it when authenticated.</p>
</section><section><h2 class="section-heading" id="costs">Costs<a class="anchor" aria-label="anchor" href="#costs"></a>
</h2>
<hr class="half-width">
<div class="section level3">
<h3 id="storage">Storage<a class="anchor" aria-label="anchor" href="#storage"></a>
</h3>
<p>The <a href="https://cloud.google.com/storage/pricing" class="external-link">storage
cost</a> of a GCS bucket depends on the data volume. The costs may vary
from a region to another. For <code>europe-west4</code>, the current
(October 2024) monthly cost is $0.020 / GB.</p>
</div>
<div class="section level3">
<h3 id="operations">Operations<a class="anchor" aria-label="anchor" href="#operations"></a>
</h3>
<p>An <a href="https://cloud.google.com/storage/pricing#operations-pricing" class="external-link">operation</a>
is an action that makes changes to or retrieves information from a
bucket and it has a tiny cost: $0.005 per 1000 operations. This applies,
for example, to listing the contents of the bucket on your terminal. The
traffic between GCP computing resources and storage within the same
region (e.g. in <code>europe-west4</code>) is free.</p>
<p>In the context of this tutorial, the operations costs are
insignificant. However, keep this is mind if you plan to write scripts
that list the bucket content from your terminal.</p>
</div>
<div class="section level3">
<h3 id="networking-and-download">Networking and download<a class="anchor" aria-label="anchor" href="#networking-and-download"></a>
</h3>
<p><a href="https://cloud.google.com/storage/pricing#network-egress" class="external-link">Downloading
data</a> from the GCS bucket to your computer has a significant cost:
the current (October 2024) cost to internet locations (excluding China
and Austalia) is $0.12 / GB.</p>
<p>In the context of the example of this tutorial, the resulting output
files are approximately 30% of the original MiniAOD dataset volume. For
example, downloading the 330 GB ouput from a processing of a 1.1 TB
MiniAOD dataset will cost $40.</p>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points</h3>
<div class="callout-content">
<ul>
<li>Google Cloud Storage bucket can be used to store the output
files.</li>
<li>The storage cost depends on the volume stored and for this type of
processing is very small.</li>
<li>The download of big output files from the bucket can be costly.</li>
</ul>
</div>
</div>
</div>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</div>
</section></section><section id="aio-03-disk-image-manual"><p>Content from <a href="03-disk-image-manual.html">Disk image</a></p>
<hr>
<p>Last updated on 2024-10-16 |

        <a href="https://github.com/cms-opendata-workshop/tutorial-lesson-cloud-processing-gcp/edit/main/episodes/03-disk-image-manual.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>Why to build a disk image for cluster nodes?</li>
<li>How to build a disk image?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Create a disk image with the container images.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<section><h2 class="section-heading" id="why-a-disk-image">Why a disk image?<a class="anchor" aria-label="anchor" href="#why-a-disk-image"></a>
</h2>
<hr class="half-width">
<p>The container image for the MiniAOD processing is very big and it
needs to be pulled to the nodes of the cluster. It can take 30 mins to
pull it. Making it available to the nodes of the cluster through a
pre-built secondary disk image speeds up the workflow start.</p>
</section><section><h2 class="section-heading" id="prerequisites">Prerequisites<a class="anchor" aria-label="anchor" href="#prerequisites"></a>
</h2>
<hr class="half-width">
<div class="section level3">
<h3 id="gcp-account-and-project">GCP account and project<a class="anchor" aria-label="anchor" href="#gcp-account-and-project"></a>
</h3>
<p>Make sure that you are in the GCP account and project that you intend
to use for this work. In your Linux terminal, type</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="ex">gcloud</span> config list</span></code></pre>
</div>
<p>The output shows your account and project.</p>
</div>
<div class="section level3">
<h3 id="enabling-services">Enabling services<a class="anchor" aria-label="anchor" href="#enabling-services"></a>
</h3>
<p>Before you can create resources on GCP, you will need to enable the
corresponding services.</p>
<p>Your project usually has several services enabled already. You can
list them with</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="ex">gcloud</span> services list <span class="at">--enabled</span></span></code></pre>
</div>
<p>You can list all available services with</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="ex">gcloud</span> services list <span class="at">--available</span></span></code></pre>
</div>
<p>but that’s a long list!</p>
<p>To build a disk image, you will need to <a href="https://cloud.google.com/endpoints/docs/openapi/enable-api#enabling_an_api" class="external-link">enable</a>
Compute Engine API (compute.googleapis.com) with</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="ex">gcloud</span> services enable compute.googleapis.com</span></code></pre>
</div>
</div>
</section><section><h2 class="section-heading" id="create-the-disk">Create the disk<a class="anchor" aria-label="anchor" href="#create-the-disk"></a>
</h2>
<hr class="half-width">
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="ex">$</span> gcloud compute disks create pfnano-disk <span class="at">--zone</span><span class="op">=</span>europe-west4-c <span class="at">--size</span><span class="op">=</span>100GB <span class="at">--type</span><span class="op">=</span>pd-standard</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a><span class="ex">WARNING:</span> You have selected a disk size of under <span class="pp">[</span><span class="ss">200GB</span><span class="pp">]</span>. This may result in poor I/O performance. For more information, see: https://developers.google.com/compute/docs/disks#performance.</span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a><span class="ex">Created</span> [https://www.googleapis.com/compute/v1/projects/<span class="op">&lt;</span>PROJECT_ID<span class="op">&gt;</span>/zones/europe-west4-c/disks/pfnano-disk].</span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a><span class="ex">NAME</span>               ZONE            SIZE_GB  TYPE         STATUS</span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a><span class="ex">pfnano-disk</span>        europe-west4-c  100      pd-standard  READY</span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a><span class="ex">New</span> disks are unformatted. You must format and mount a disk before it</span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a><span class="ex">can</span> be used. You can find instructions on how to do this at:</span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a><span class="ex">https://cloud.google.com/compute/docs/disks/add-persistent-disk#formatting</span></span></code></pre>
</div>
</section><section><h2 class="section-heading" id="create-a-vm">Create a VM<a class="anchor" aria-label="anchor" href="#create-a-vm"></a>
</h2>
<hr class="half-width">
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="ex">$</span> gcloud compute instances create vm-work <span class="at">--zone</span><span class="op">=</span>europe-west4-c <span class="at">--machine-type</span><span class="op">=</span>e2-standard-4 <span class="at">--disk</span><span class="op">=</span>name=pfnano-disk <span class="at">--boot-disk-size</span><span class="op">=</span>100GB <span class="at">--image-family</span><span class="op">=</span>cos-113-lts <span class="at">--image-project</span><span class="op">=</span>cos-cloud</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a><span class="ex">WARNING:</span> You have selected a disk size of under <span class="pp">[</span><span class="ss">200GB</span><span class="pp">]</span>. This may result in poor I/O performance. For more information, see: https://developers.google.com/compute/docs/disks#performance.</span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a><span class="ex">Created</span> [https://www.googleapis.com/compute/v1/projects/<span class="op">&lt;</span>PROJECT_ID<span class="op">&gt;</span>/zones/europe-west4-c/instances/vm-work].</span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a><span class="ex">WARNING:</span> Some requests generated warnings:</span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a> <span class="ex">-</span> Disk size: <span class="st">'100 GB'</span> is larger than image size: <span class="st">'10 GB'</span>. You might need to resize the root repartition manually if the operating system does not support automatic resizing. See https://cloud.google.com/compute/docs/disks/add-persistent-disk#resize_pd for details.</span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a><span class="ex">NAME</span>     ZONE            MACHINE_TYPE   PREEMPTIBLE  INTERNAL_IP  EXTERNAL_IP    STATUS</span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a><span class="ex">vm-work</span>  europe-west4-c  e2-standard-4               10.164.0.2   35.204.202.73  RUNNING</span></code></pre>
</div>
<p>Login to this VM</p>
<pre><code>$ gcloud compute ssh vm-work --zone=europe-west4-c
Updating project ssh metadata...⠶Updated [https://www.googleapis.com/compute/v1/projects/&lt;PROJECT_ID&gt;].
Updating project ssh metadata...done.
Waiting for SSH key to propagate.
Warning: Permanently added 'compute.5401844593939611330' (ED25519) to the list of known hosts.
kati@vm-work ~ $ </code></pre>
<p>Check the logical links that indicate the disk address</p>
<pre><code>$ ls -l /dev/disk/by-id/google-*
lrwxrwxrwx 1 root root  9 Oct 16 13:31 /dev/disk/by-id/google-persistent-disk-0 -&gt; ../../sda
lrwxrwxrwx 1 root root 10 Oct 16 13:31 /dev/disk/by-id/google-persistent-disk-0-part1 -&gt; ../../sda1
[...]
google-persistent-disk-0-part9 -&gt; ../../sda9
lrwxrwxrwx 1 root root  9 Oct 16 13:31 /dev/disk/by-id/google-persistent-disk-1 -&gt; ../../sdb</code></pre>
<p>It is the one without partitioning, in this <code>sdb</code>. Note
that it can be other way round!</p>
<p>Format the disk</p>
<pre><code>$ sudo mkfs.ext4 -m 0 -E lazy_itable_init=0,lazy_journal_init=0,discard /dev/sdb
mke2fs 1.47.0 (5-Feb-2023)
Discarding device blocks: done
Creating filesystem with 26214400 4k blocks and 6553600 inodes
Filesystem UUID: 3975c0a0-6b73-4b5c-81a0-9d8531837479
Superblock backups stored on blocks:
        32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632, 2654208,
        4096000, 7962624, 11239424, 20480000, 23887872

Allocating group tables: done
Writing inode tables: done
Creating journal (131072 blocks): done
Writing superblocks and filesystem accounting information: done</code></pre>
</section><section><h2 class="section-heading" id="mount-the-disk">Mount the disk<a class="anchor" aria-label="anchor" href="#mount-the-disk"></a>
</h2>
<hr class="half-width">
<pre><code>$ sudo mkdir -p /mnt/disks/img
$ sudo mount -o discard,defaults /dev/sdb /mnt/disks/img
$ sudo chmod a+w /mnt/disks/img</code></pre>
</section><section><h2 class="section-heading" id="configure-docker-and-pull-the-image">Configure docker and pull the image<a class="anchor" aria-label="anchor" href="#configure-docker-and-pull-the-image"></a>
</h2>
<hr class="half-width">
<p>Add a line <code>"data-root": "/mnt/disks/img"</code> to the docker
config file <code>/etc/docker/daemon.json</code> so that docker stores
data in the mounted disk. The file becomes:</p>
<pre><code>{
        "live-restore": true,
        "log-opts": {
                "tag": "{{.Name}}"
        },
        "storage-driver": "overlay2",
        "mtu": 1460,
        "data-root": "/mnt/disks/img"
}</code></pre>
<p>Remember the comma before the line that you added! I made the
mistake, you do not have to…</p>
<p>Restart the docker service</p>
<pre><code>sudo systemctl restart docker</code></pre>
<p>Pull the images that you need. In the example workflow we use three
of them (in addition to a tiny python image), so we pull:</p>
<pre><code>docker pull ghcr.io/katilp/pfnano-image-build:main
docker pull cernopendata/cernopendata-client
docker pull rootproject/root:latest</code></pre>
<p>After the pull is ready, you can see them with:</p>
<pre><code>$ docker image ls
REPOSITORY                          TAG       IMAGE ID       CREATED         SIZE
rootproject/root                    latest    34eb35079484   4 weeks ago     2.76GB
cernopendata/cernopendata-client    latest    f690d7308889   7 weeks ago     282MB
ghcr.io/katilp/pfnano-image-build   main      d95521bc96a9   11 months ago   32.1GB</code></pre>
<p>Exit from the VM with <code>exit</code> and stop it</p>
<pre><code>gcloud compute instances stop vm-work</code></pre>
</section><section><h2 class="section-heading" id="create-the-image">Create the image<a class="anchor" aria-label="anchor" href="#create-the-image"></a>
</h2>
<hr class="half-width">
<pre><code>gcloud compute images create pfnano-image-disk --project=hip-new-full-account --source-disk=pfnano-disk --source-disk-zone=europe-west4-c --storage-location=europe-west4</code></pre>
</section><section><h2 class="section-heading" id="delete-the-disk-and-the-vm">Delete the disk and the VM<a class="anchor" aria-label="anchor" href="#delete-the-disk-and-the-vm"></a>
</h2>
<hr class="half-width">
<p>Now as you have the image created, you can delete the VM and the
original disk.</p>
<pre><code>gcloud compute instances delete vm-work --zone=europe-west4-c</code></pre>
<pre><code>gcloud compute disks delete pfnano-disk --zone=europe-west4-c</code></pre>
</section><section><h2 class="section-heading" id="costs">Costs<a class="anchor" aria-label="anchor" href="#costs"></a>
</h2>
<hr class="half-width">
<div class="section level3">
<h3 id="vm">VM<a class="anchor" aria-label="anchor" href="#vm"></a>
</h3>
<p>The VM costs depends on the time</p>
</div>
<div class="section level3">
<h3 id="disk">Disk<a class="anchor" aria-label="anchor" href="#disk"></a>
</h3>
</div>
<div class="section level3">
<h3 id="image">Image<a class="anchor" aria-label="anchor" href="#image"></a>
</h3>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points</h3>
<div class="callout-content">
<ul>
<li>A secondary boot disk with the container image preloaded can speed
up the workflow start.</li>
</ul>
</div>
</div>
</div>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</div>
</section></section><section id="aio-04-cluster"><p>Content from <a href="04-cluster.html">Kubernetes cluster</a></p>
<hr>
<p>Last updated on 2024-10-16 |

        <a href="https://github.com/cms-opendata-workshop/tutorial-lesson-cloud-processing-gcp/edit/main/episodes/04-cluster.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How to create a Google Kubernetes Engine cluster?</li>
<li>How to access the cluster from the command line?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Learn to create a Google Kubernetes Engine cluster.</li>
<li>Access the cluster and inspect it from the command line.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<section><h2 class="section-heading" id="prerequisites">Prerequisites<a class="anchor" aria-label="anchor" href="#prerequisites"></a>
</h2>
<hr class="half-width">
<div class="section level3">
<h3 id="gcp-account-and-project">GCP account and project<a class="anchor" aria-label="anchor" href="#gcp-account-and-project"></a>
</h3>
<p>Make sure that you are in the GCP account and project that you intend
to use for this work. In your Linux terminal, type</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">BASH<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode bash" tabindex="0"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="ex">gcloud</span> config list</span></code></pre>
</div>
<p>The output shows your account and project.</p>
</div>
<div class="section level3">
<h3 id="enabling-services">Enabling services<a class="anchor" aria-label="anchor" href="#enabling-services"></a>
</h3>
<p>Before you can create resources on GCP, you will need to enable
them</p>
<p>If this is your first project or you created it from the Google Cloud
Console Web UI, it will have several services enabled.</p>
</div>
</section><section><h2 class="section-heading" id="get-the-code">Get the code<a class="anchor" aria-label="anchor" href="#get-the-code"></a>
</h2>
<hr class="half-width"></section><section><h2 class="section-heading" id="create-the-cluster">Create the cluster<a class="anchor" aria-label="anchor" href="#create-the-cluster"></a>
</h2>
<hr class="half-width"></section><section><h2 class="section-heading" id="costs">Costs<a class="anchor" aria-label="anchor" href="#costs"></a>
</h2>
<hr class="half-width">
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points</h3>
<div class="callout-content">
<ul>
<li>Google Cloud Storage bucket can be used to store the output
files.</li>
<li>The storage cost depends on the volume stored and for this type of
processing is very small.</li>
<li>The download of the output files for the bucket has a signicant
cost.</li>
</ul>
</div>
</div>
</div>
<!--
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use.
 -->
</section></section>
</div>
    </main>
</div>
<!-- END  : inst/pkgdown/templates/content-extra.html -->

      </div>
<!--/div.row-->
      		<footer class="row footer mx-md-3"><hr>
<div class="col-md-6">
        <p>This lesson is subject to the <a href="CODE_OF_CONDUCT.html">Code of Conduct</a></p>
        <p>

        <a href="https://github.com/cms-opendata-workshop/tutorial-lesson-cloud-processing-gcp/edit/main/README.md" class="external-link">Edit on GitHub</a>

	
        | <a href="https://github.com/cms-opendata-workshop/tutorial-lesson-cloud-processing-gcp/blob/main/CONTRIBUTING.md" class="external-link">Contributing</a>
        | <a href="https://github.com/cms-opendata-workshop/tutorial-lesson-cloud-processing-gcp/" class="external-link">Source</a></p>
				<p><a href="https://github.com/cms-opendata-workshop/tutorial-lesson-cloud-processing-gcp/blob/main/CITATION.cff" class="external-link">Cite</a> | <a href="mailto:cms-dpoa-coordinator@cern.ch">Contact</a> | <a href="https://opendata.cern.ch/docs/about-cms" class="external-link">About</a></p>
			</div>
			<div class="col-md-6">

        <p>Materials licensed under <a href="LICENSE.html">CC-BY 4.0</a> by the authors</p>

        <p>Template licensed under <a href="https://creativecommons.org/licenses/by-sa/4.0/" class="external-link">CC-BY 4.0</a> by <a href="https://carpentries.org/" class="external-link">The Carpentries</a></p>
        <p>Built with <a href="https://github.com/carpentries/sandpaper/tree/0.16.9" class="external-link">sandpaper (0.16.9)</a>, <a href="https://github.com/carpentries/pegboard/tree/0.7.6" class="external-link">pegboard (0.7.6)</a>, and <a href="https://github.com/cms-opendata-workshop/varnish/tree/405b7a74ee1b2fc89c3e49e116ce96d4d65182b3" class="external-link">varnish (1.0.3)</a></p>
			</div>
		</footer>
</div> <!-- / div.container -->
	<div id="to-top">
		<a href="#top">
      <i class="search-icon" data-feather="arrow-up" role="img" aria-label="Back To Top"></i><br><!-- <span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top --><span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top
		</a>
	</div>
  <script type="application/ld+json">
    {
  "@context": "https://schema.org",
  "@type": "TrainingMaterial",
  "@id": "https://cms-opendata-workshop.github.io/tutorial-lesson-cloud-processing-gcp/aio.html",
  "inLanguage": "en",
  "dct:conformsTo": "https://bioschemas.org/profiles/TrainingMaterial/1.0-RELEASE",
  "description": "A Carpentries Lesson teaching foundational data and coding skills to researchers worldwide",
  "keywords": "software, data, lesson, CMS",
  "name": "All in One View",
  "creativeWorkStatus": "active",
  "url": "https://cms-opendata-workshop.github.io/tutorial-lesson-cloud-processing-gcp/aio.html",
  "identifier": "https://cms-opendata-workshop.github.io/tutorial-lesson-cloud-processing-gcp/aio.html",
  "dateCreated": "2024-10-10",
  "dateModified": "2024-10-16",
  "datePublished": "2024-10-16"
}

  </script><script>
		feather.replace();
	</script>
</body>
</html><!-- END:   inst/pkgdown/templates/layout.html-->

